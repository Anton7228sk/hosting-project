import docker
import time

# 1. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Docker (–æ–Ω –∏—â–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏)
# –≠—Ç–æ –∫–∞–∫ "–≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á –≤ –∑–∞–∂–∏–≥–∞–Ω–∏–µ"
client = docker.from_env()


def start_container(name, port):
    """
    –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å Nginx.
    name: –∏–º—è —Å–∞–π—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "site-anton")
    port: –Ω–∞ –∫–∞–∫–æ–º –ø–æ—Ä—Ç—É –æ–Ω –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, 8091)
    """
    print(f"üöÄ –ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä {name} –Ω–∞ –ø–æ—Ä—Ç—É {port}...")

    try:
        # –≠—Ç–æ –∞–Ω–∞–ª–æ–≥ –∫–æ–º–∞–Ω–¥—ã: docker run -d -p 8091:80 --name site-anton nginx
        container = client.containers.run(
            "nginx:latest",  # –ö–∞–∫–æ–π –æ–±—Ä–∞–∑ (Image)
            detach=True,  # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ñ–æ–Ω–µ (-d)
            ports={"80/tcp": port},  # –ü—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤ (-p)
            name=name,  # –ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        )
        print(f"‚úÖ –£—Å–ø–µ—Ö! ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: {container.short_id}")
        return container

    except Exception as e:
        print(f"üî• –û—à–∏–±–∫–∞: {e}")
        return None


def stop_container(name):
    """
    –ù–∞—Ö–æ–¥–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ –∏–º–µ–Ω–∏ –∏ —É–¥–∞–ª—è–µ—Ç –µ–≥–æ
    """
    print(f"üíÄ –£–Ω–∏—á—Ç–æ–∂–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä {name}...")
    try:
        # –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        container = client.containers.get(name)
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
        container.stop()
        # –£–¥–∞–ª—è–µ–º
        container.remove()
        print("‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–¥–∞–ª–µ–Ω.")
    except docker.errors.NotFound:
        print("ü§∑‚Äç‚ôÇÔ∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω (—É–∂–µ —É–¥–∞–ª–µ–Ω?)")
    except Exception as e:
        print(f"üî• –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {e}")


# --- –ë–ª–æ–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é) ---
if __name__ == "__main__":
    TEST_NAME = "test_site_alpha"

    # 1. –°–Ω–∞—á–∞–ª–∞ –ø–æ—á–∏—Å—Ç–∏–º (–≤–¥—Ä—É–≥ –æ—Å—Ç–∞–ª—Å—è —Å—Ç–∞—Ä—ã–π –º—É—Å–æ—Ä)
    stop_container(TEST_NAME)

    # 2. –ó–∞–ø—É—Å—Ç–∏–º –Ω–æ–≤—ã–π
    start_container(TEST_NAME, 8095)

    print("‚è≥ –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã —Ç—ã —É—Å–ø–µ–ª –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä...")
    time.sleep(10)

    # 3. –£–¥–∞–ª–∏–º –∑–∞ —Å–æ–±–æ–π
    stop_container(TEST_NAME)
